{% extends "global/html_struct.html" %}
{% load crispy_forms_tags %}

{% block content %}

<div class="row">
    <div class="col-sm-8 offset-md-2">
        <form method="post" autocomplete="off" enctype="multipart/form-data" id="main-form" action="">
            {% csrf_token %}
            {{ frm | crispy }}
            <h5>Refacciones</h5>

            <table class="table table-striped table-sm table-responsive-md">
                <thead>
                    <tr>
                        <th>Refacci√≥n</th>
                        <th>Cantidad</th>
                        <th>Costo</th>
                        <th>Importe</th>
                    </tr>
                </thead>
                <tbody id="data-tbl">
                    {% for pza in piezas %}
                        <tr>
                            <td>
                                {{ pza }}
                                <span class="pza{% for prov in proveedores %}{% if pza in prov.piezas.all %} prov-{{ prov.pk }}{% endif %}{% endfor %}"></span>
                            </td>
                            <td>
                                <input type="number" class="form-control" name="pza-cant-{{ pza.pk }}" id="pza-cant-{{ pza.pk }}" value="{% for pza_req in piezas_entradas %}{% if pza_req.pieza.pk == pza.pk %}{{pza_req.cantidad}}{% endif %}{% endfor %}" onchange="calculaImporte({{ pza.pk }})" />
                            </td>
                            <td>
                                <input type="number" class="form-control" name="pza-costo-{{ pza.pk }}" id="pza-costo-{{ pza.pk }}" value="{% for pza_req in piezas_entradas %}{% if pza_req.pieza.pk == pza.pk %}{{pza_req.costo}}{% endif %}{% endfor %}" onchange="calculaImporte({{ pza.pk }})" />
                            </td>
                            <td>
                                <input type="number" class="form-control" name="pza-importe-{{ pza.pk }}" id="pza-importe-{{ pza.pk }}" value="{% for pza_req in piezas_entradas %}{% if pza_req.pieza.pk == pza.pk %}{{pza_req.importe}}{% endif %}{% endfor %}" />
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p>* Piezas que no surte el proveedor</p>

            <button type="submit" class="btn btn-outline-primary" id="btn-save" >Guardar</button>
        </form>
    </div>
</div>

<script type="text/javascript">
    let setPzasProvIndicador = () => {
        let idprov = $( "#id_proveedor" ).val();
        if( "" != idprov ) {
            $( "span.pza" ).html( '*' );
            $( "span.prov-" + idprov ).html( '' );
        } else {
            $( "span.pza" ).html( '' );
        }
    }
    $( "#id_proveedor" ).change( setPzasProvIndicador );
    if( "" != $( "#id_proveedor" ).val() ) {
        setPzasProvIndicador();
    }
    let calculaImporte = (idpza) => {
        let cantidad = parseFloat( $( "#pza-cant-" + idpza ).val() );
        let costo = parseFloat( $( "#pza-costo-" + idpza ).val() );
        let importe = costo * cantidad;
        if( !isNaN( cantidad ) ) {
            $( "#pza-cant-" + idpza )[0].value = cantidad.asMoney();
        } else {
            $( "#pza-importe-" + idpza )[0].value = '';
        }
        if( !isNaN( costo ) ) {
            $( "#pza-costo-" + idpza )[0].value = costo.asMoney();
        } else {
            $( "#pza-importe-" + idpza )[0].value = '';
        }
        if( !isNaN( importe ) ) {
            $( "#pza-importe-" + idpza )[0].value = importe.asMoney();
        }
    }
</script>

{% endblock %}